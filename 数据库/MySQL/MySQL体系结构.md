# MySQL逻辑架构



图为MySQL5.7版本典型的逻辑架构图

![MySQL逻辑架构图](https://notes-img2022.oss-cn-shenzhen.aliyuncs.com/img/image-20230109100656787.png)

MySQL逻辑架构分为三层，分别是连接层、服务层、存储引擎层。

**第一层连接层是连接管理的，包括连接处理、身份认证、权限获取、安全等功能**。客户端通过TCP连接MySQL服务器，MySQL服务器对传输过来的账号密码进行身份认证和权限获取。

- 用户名和密码不对，会收到一个`Access denied for user`错误，客户端程序结束执行
- 用户名密码认证通过，会从权限表查出账号拥有的权限与连接关联，之后的权限判断逻辑，都将依赖于此时读到的权限

MySQL会从线程池分配一个线程专门与这个客户端进行交互，每个连接都从线程池获取，省去创建和销毁线程的开销。

**第二层是服务层，包括SQL接口、解析器、优化器、查询缓存**。

**SQL接口（SQL Interface）**：接收用户的SQL命令，并且返回用户查询的结果。支持DML、DDL、存储过程、视图、触发器、自定义函数等多种SQL语言接口。

**解析器（Parser）**：对SQL命令进行验证和解析，并为其创建**语法树**，根据数据字典丰富查询语法树，**会验证该客户端是否具有执行该查询的权限**。后续SQL语句的传递和处理都是基于这个结构的。

**优化器（Optimizer）**：SQL语句解析后，查询之前用查询优化器确定SQL语句的执行路径，生成一个**执行计划**。这个执行计划表明应该使用哪些索引进行查询，表之间的连接顺序如何，最后会安装执行计划的步骤调用存储引擎提供的方法来真正执行查询，并将查询结果返回给用户。使用**选取-投影-连接**策略进行查询。

```sql
SELECT id,name FROM student WHERE gender = '女';
```

这个SELECT查询先根据WHERE语句进行**选取**，而不是将表全部查询出来以后再进行gender过滤。这个SELECT查询先根据id和name进行属性**投影**，而不是将属性全部取出以后再进行过
滤，将这两个查询条件**连接**起来生成最终查询结果。

**查询缓存（Caches&Buffers）**：查询缓存可以用来缓存一条SELECT语句的执行结果，如果能找到对应的执行结果，就直接将结果返回，不必进行查询解析、优化、执行等过程。查询缓存在不同客户端之间共享。**查询缓存在MySQL8.0删除**。

**第三层是存储引擎层，负责数据的存储和提取**。服务器通过API与存储引擎进行通信。不同的存储引擎具有的功能不同。

MySQL 8.25默认的支持的存储引擎如下：

![image-20230112084800461](https://notes-img2022.oss-cn-shenzhen.aliyuncs.com/img/image-20230112084800461.png)





# SQL执行流程

![image-20230112220649910](https://notes-img2022.oss-cn-shenzhen.aliyuncs.com/img/image-20230112220649910.png)

MySQl中的查询流程：

1. 查询缓存：服务器如果在查询缓存中发现这条SQL语句，就会直接将结果返回给客户端；如果没有发现，就进入解析器阶段。

2. 解析器：**对SQL语句进行语法分析、语义检查**。分析器先做“**词法分析**”，输入的多个字符串和空格组成的一条SQL语句，MySQL需要识别里面字符串分别是什么，代表什么。比如“select”关键字识别成查询语句，字符串“T”识别成表名。再做语法分析。根本词法分析的结果，语法分析器会根据语法规则，判断SQL语句是否满足MySQL语法。如果SQL语句正确的话就会生成一个语法树。比如：

   ```sql
   select username ismale from userinfo where age<20 and level<5 and 1=1
   ```

   会生成一个这样的语法树![image-20230112221924882](https://notes-img2022.oss-cn-shenzhen.aliyuncs.com/img/image-20230112221924882.png)

3. 优化器：确定SQL语句的执行计划。比如是根据**全表检索**还是根据**索引检索**等。在查询优化器中，可以分为**逻辑查询**优化阶段和**物理查询**优化阶段。确定执行计划后进入执行器阶段

4. 执行器：在执行之前判断该用户是否具备权限。如果没有，就会返回权限错误。如果具备权限，就执行SQL查询并返回结果。在MySQL8.0以下的版本，如果设置查询缓存，会将结果进行缓存。



# MySQL存储引擎



## InnoDB存储引擎

MYSQL5.5版本默认的存储引擎。InnoDB采用MVCC来支持高并发，并且实现四个标准的隔离级别。默认隔离级别是REPEATABLE READ（可重复读），并且通过间隙锁策略防止幻读。

InnoDB表是基于聚簇索引建立的。

InnoDB支持事务、行级锁、外键。



## MyISAM存储引擎

MyISAM不支持事务、行级锁、外键。

