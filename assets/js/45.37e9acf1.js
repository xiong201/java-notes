(window.webpackJsonp=window.webpackJsonp||[]).push([[45],{376:function(s,t,a){"use strict";a.r(t);var n=a(7),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"为什么需要定时任务"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#为什么需要定时任务"}},[s._v("#")]),s._v(" 为什么需要定时任务？")]),s._v(" "),t("p",[s._v("我们来看一下几个非常常见的业务场景：")]),s._v(" "),t("ol",[t("li",[s._v("某系统凌晨要进行数据备份。")]),s._v(" "),t("li",[s._v("某电商平台，用户下单半个小时未支付的情况下需要自动取消订单。")]),s._v(" "),t("li",[s._v("某媒体聚合平台，每 10 分钟动态抓取某某网站的数据为自己所用。")]),s._v(" "),t("li",[s._v("某博客平台，支持定时发送文章。")]),s._v(" "),t("li",[s._v("某基金平台，每晚定时计算用户当日收益情况并推送给用户最新的数据。")]),s._v(" "),t("li",[s._v("......")])]),s._v(" "),t("p",[s._v("这些场景往往都要求我们在某个特定的时间去做某个事情。")]),s._v(" "),t("h1",{attrs:{id:"单机定时任务技术选型"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#单机定时任务技术选型"}},[s._v("#")]),s._v(" 单机定时任务技术选型")]),s._v(" "),t("h2",{attrs:{id:"timer"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#timer"}},[s._v("#")]),s._v(" Timer")]),s._v(" "),t("p",[t("code",[s._v("java.util.Timer")]),s._v("是 JDK 1.3 开始就已经支持的一种定时任务的实现方式。")]),s._v(" "),t("p",[t("code",[s._v("Timer")]),s._v(" 内部使用一个叫做 "),t("code",[s._v("TaskQueue")]),s._v(" 的类存放定时任务，它是一个基于最小堆实现的优先级队列。"),t("code",[s._v("TaskQueue")]),s._v(" 会按照任务距离下一次执行时间的大小将任务排序，保证在堆顶的任务最先执行。这样在需要执行任务时，每次只需要取出堆顶的任务运行即可！")]),s._v(" "),t("p",[t("code",[s._v("Timer")]),s._v(" 使用起来比较简单，通过下面的方式我们就能创建一个 1s 之后执行的定时任务。")]),s._v(" "),t("div",{staticClass:"language-java extra-class"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 示例代码：")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("TimerTask")]),s._v(" task "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("TimerTask")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("run")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"当前时间: "')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Date")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"n"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"线程名称: "')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("currentThread")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getName")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"当前时间: "')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Date")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"n"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"线程名称: "')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("currentThread")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getName")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Timer")]),s._v(" timer "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Timer")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Timer"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("long")]),s._v(" delay "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000L")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\ntimer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("schedule")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("task"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" delay"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//输出：")]),s._v("\n当前时间"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Fri")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("May")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("47")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("CST")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("n线程名称"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" main\n当前时间"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Fri")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("May")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("48")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("CST")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("n线程名称"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Timer")]),s._v("\n\n")])])]),t("p",[s._v("不过其缺陷较多，比如一个 "),t("code",[s._v("Timer")]),s._v(" 一个线程，这就导致 "),t("code",[s._v("Timer")]),s._v(" 的任务的执行只能串行执行，一个任务执行时间过长的话会影响其他任务（性能非常差），再比如发生异常时任务直接停止（"),t("code",[s._v("Timer")]),s._v(" 只捕获了 "),t("code",[s._v("InterruptedException")]),s._v(" ）。")]),s._v(" "),t("h2",{attrs:{id:"scheduledexecutorservice"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#scheduledexecutorservice"}},[s._v("#")]),s._v(" ScheduledExecutorService")]),s._v(" "),t("p",[t("code",[s._v("ScheduledExecutorService")]),s._v(" 是一个接口，有多个实现类，比较常用的是 "),t("code",[s._v("ScheduledThreadPoolExecutor")]),s._v(" 。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://notes-img2022.oss-cn-shenzhen.aliyuncs.com/img/image-20230723100442281.png",alt:"image-20230723100442281"}})]),s._v(" "),t("p",[t("code",[s._v("ScheduledThreadPoolExecutor")]),s._v(" 本身就是一个线程池，支持任务并发执行。并且，其内部使用 "),t("code",[s._v("DelayQueue")]),s._v(" 作为任务队列。")]),s._v(" "),t("div",{staticClass:"language-java extra-class"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 示例代码：")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("TimerTask")]),s._v(" repeatedTask "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("TimerTask")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@SneakyThrows")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("run")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"当前时间: "')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Date")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"n"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"线程名称: "')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("currentThread")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getName")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"当前时间: "')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Date")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"n"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"线程名称: "')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("currentThread")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getName")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ScheduledExecutorService")]),s._v(" executor "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Executors")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("newScheduledThreadPool")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("long")]),s._v(" delay  "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000L")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("long")]),s._v(" period "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000L")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nexecutor"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("scheduleAtFixedRate")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("repeatedTask"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" delay"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" period"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("TimeUnit")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("MILLISECONDS")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("delay "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" period "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nexecutor"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("shutdown")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//输出：")]),s._v("\n当前时间"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Fri")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("May")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("40")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("46")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("CST")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("n线程名称"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" main\n当前时间"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Fri")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("May")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("40")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("47")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("CST")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("n线程名称"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" pool"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("thread"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n当前时间"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Fri")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("May")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("40")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("48")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("CST")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("n线程名称"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" pool"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("thread"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n当前时间"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Fri")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("May")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("40")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("49")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("CST")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("n线程名称"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" pool"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("thread"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n当前时间"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Fri")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("May")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("40")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("50")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("CST")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("n线程名称"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" pool"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("thread"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n当前时间"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Fri")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("May")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("40")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("51")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("CST")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("n线程名称"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" pool"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("thread"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n当前时间"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Fri")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("May")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("40")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("52")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("CST")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v("n线程名称"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" pool"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("thread"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n\n")])])]),t("h2",{attrs:{id:"spring-task"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#spring-task"}},[s._v("#")]),s._v(" Spring Task")]),s._v(" "),t("p",[s._v("我们直接通过 Spring 提供的 "),t("code",[s._v("@Scheduled")]),s._v(" 注解即可定义定时任务，非常方便！")]),s._v(" "),t("div",{staticClass:"language-java extra-class"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n * cron：使用Cron表达式。　每分钟的1，2秒运行\n */")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Scheduled")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("cron "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1-2 * * * * ? "')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("reportCurrentTimeWithCronExpression")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  log"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("info")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Cron Expression: The time is now {}"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" dateFormat"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("format")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Date")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\n")])])]),t("p",[s._v("并且，Spring Task 还是支持 "),t("strong",[s._v("Cron 表达式")]),s._v(" 的。Cron 表达式主要用于定时作业(定时任务)系统定义执行时间或执行频率的表达式，非常厉害，你可以通过 Cron 表达式进行设置定时任务每天或者每个月什么时候执行等等操作。咱们要学习定时任务的话，Cron 表达式是一定是要重点关注的。推荐一个在线 Cron 表达式生成器：http://cron.qqe2.com/")]),s._v(" "),t("p",[s._v("Spring Task 底层是基于 JDK 的 "),t("code",[s._v("ScheduledThreadPoolExecutor")]),s._v(" 线程池来实现的。")]),s._v(" "),t("p",[t("strong",[s._v("优缺点总结：")])]),s._v(" "),t("ul",[t("li",[s._v("优点： 简单，轻量，支持 Cron 表达式")]),s._v(" "),t("li",[s._v("缺点 ：功能单一")])]),s._v(" "),t("h2",{attrs:{id:"时间轮"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#时间轮"}},[s._v("#")]),s._v(" 时间轮")]),s._v(" "),t("p",[s._v("Kafka、Dubbo、ZooKeeper、Netty 、Caffeine 、Akka 中都有对时间轮的实现。")]),s._v(" "),t("p",[s._v("时间轮简单来说就是一个环形的队列（底层一般基于数组实现），队列中的每一个元素（时间格）都可以存放一个定时任务列表。")]),s._v(" "),t("p",[s._v("时间轮中的每个时间格代表了时间轮的基本时间跨度或者说时间精度，加入时间一秒走一个时间格的话，那么这个时间轮的最高精度就是 1 秒（也就是说 3 s 和 3.9s 会在同一个时间格中）。")]),s._v(" "),t("p",[s._v("下图是一个有 12 个时间格的时间轮，转完一圈需要 12 s。当我们需要新建一个 3s 后执行的定时任务，只需要将定时任务放在下标为 3 的时间格中即可。当我们需要新建一个 9s 后执行的定时任务，只需要将定时任务放在下标为 9 的时间格中即可。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://notes-img2022.oss-cn-shenzhen.aliyuncs.com/img/image-20230723100719147.png",alt:"image-20230723100719147"}})]),s._v(" "),t("p",[s._v("那当我们需要创建一个 13s 后执行的定时任务怎么办呢？这个时候可以引入一叫做 "),t("strong",[s._v("圈数/轮数")]),s._v(" 的概念，也就是说这个任务还是放在下标为 3 的时间格中， 不过它的圈数为 2 。")]),s._v(" "),t("p",[s._v("除了增加圈数这种方法之外，还有一种 "),t("strong",[s._v("多层次时间轮")]),s._v(" （类似手表），Kafka 采用的就是这种方案。")]),s._v(" "),t("p",[s._v("针对下图的时间轮，我来举一个例子便于大家理解。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://notes-img2022.oss-cn-shenzhen.aliyuncs.com/img/image-20230723100736099.png",alt:"image-20230723100736099"}})]),s._v(" "),t("p",[s._v("上图的时间轮，第 1 层的时间精度为 1 ，第 2 层的时间精度为 20 ，第 3 层的时间精度为 400。假如我们需要添加一个 350s 后执行的任务 A 的话（当前时间是 0s），这个任务会被放在第 2 层（因为第二层的时间跨度为 20*20=400>350）的第 350/20=17 个时间格子。")]),s._v(" "),t("p",[s._v("当第一层转了 17 圈之后，时间过去了 340s ，第 2 层的指针此时来到第 17 个时间格子。此时，第 2 层第 17 个格子的任务会被移动到第 1 层。")]),s._v(" "),t("p",[s._v("任务 A 当前是 10s 之后执行，因此它会被移动到第 1 层的第 10 个时间格子。")]),s._v(" "),t("p",[s._v("这里在层与层之间的移动也叫做时间轮的升降级。参考手表来理解就好！")]),s._v(" "),t("p",[t("strong",[s._v("时间轮比较适合任务数量比较多的定时任务场景，它的任务写入和执行的时间复杂度都是 0（1）。")])]),s._v(" "),t("h1",{attrs:{id:"分布式定时任务技术选型"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#分布式定时任务技术选型"}},[s._v("#")]),s._v(" 分布式定时任务技术选型")]),s._v(" "),t("p",[s._v("上面提到的一些定时任务的解决方案都是在单机下执行的，适用于比较简单的定时任务场景比如每天凌晨备份一次数据。")]),s._v(" "),t("p",[s._v("如果我们需要一些高级特性比如支持任务在分布式场景下的分片和高可用的话，我们就需要用到分布式任务调度框架了。")]),s._v(" "),t("p",[s._v("通常情况下，一个定时任务的执行往往涉及到下面这些角色：")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("任务")]),s._v(" ： 首先肯定是要执行的任务，这个任务就是具体的业务逻辑比如定时发送文章。")]),s._v(" "),t("li",[t("strong",[s._v("调度器")]),s._v(" ：其次是调度中心，调度中心主要负责任务管理，会分配任务给执行器。")]),s._v(" "),t("li",[t("strong",[s._v("执行器")]),s._v(" ： 最后就是执行器，执行器接收调度器分派的任务并执行。")])]),s._v(" "),t("h2",{attrs:{id:"quartz"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#quartz"}},[s._v("#")]),s._v(" Quartz")]),s._v(" "),t("p",[s._v("一个很火的开源任务调度框架，完全由"),t("code",[s._v("Java")]),s._v("写成。"),t("code",[s._v("Quartz")]),s._v(" 可以说是 Java 定时任务领域的老大哥或者说参考标准，其他的任务调度框架基本都是基于 "),t("code",[s._v("Quartz")]),s._v(" 开发的，比如当当网的"),t("code",[s._v("elastic-job")]),s._v("就是基于"),t("code",[s._v("quartz")]),s._v("二次开发之后的分布式调度解决方案。")]),s._v(" "),t("p",[s._v("使用 "),t("code",[s._v("Quartz")]),s._v(" 可以很方便地与 "),t("code",[s._v("Spring")]),s._v(" 集成，并且支持动态添加任务和集群。但是，"),t("code",[s._v("Quartz")]),s._v(" 使用起来也比较麻烦，API 繁琐。")]),s._v(" "),t("p",[s._v("并且，"),t("code",[s._v("Quzrtz")]),s._v(" 并没有内置 UI 管理控制台，不过你可以使用 "),t("a",{attrs:{href:"https://github.com/zhaopeiym/quartzui",target:"_blank",rel:"noopener noreferrer"}},[s._v("quartzui"),t("OutboundLink")],1)]),s._v(" "),t("h2",{attrs:{id:"elastic-job"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#elastic-job"}},[s._v("#")]),s._v(" Elastic-Job")]),s._v(" "),t("p",[t("code",[s._v("Elastic-Job")]),s._v(" 是当当网开源的一个基于"),t("code",[s._v("Quartz")]),s._v("和"),t("code",[s._v("ZooKeeper")]),s._v("的分布式调度解决方案，由两个相互独立的子项目 "),t("code",[s._v("Elastic-Job-Lite")]),s._v(" 和 "),t("code",[s._v("Elastic-Job-Cloud")]),s._v(" 组成，一般我们只要使用 "),t("code",[s._v("Elastic-Job-Lite")]),s._v(" 就好。")]),s._v(" "),t("p",[t("code",[s._v("ElasticJob")]),s._v(" 支持任务在分布式场景下的分片和高可用、任务可视化管理等功能。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://notes-img2022.oss-cn-shenzhen.aliyuncs.com/img/20210608080437356.png",alt:"img"}})]),s._v(" "),t("p",[s._v("ElasticJob-Lite 的架构设计如下图所示：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://notes-img2022.oss-cn-shenzhen.aliyuncs.com/img/up-a8f63f828666d43009d5d3497bcbd2cfb61.png",alt:"img"}})]),s._v(" "),t("p",[s._v("从上图可以看出，"),t("code",[s._v("Elastic-Job")]),s._v(" 没有调度中心这一概念，而是使用 "),t("code",[s._v("ZooKeeper")]),s._v(" 作为注册中心，注册中心负责协调分配任务到不同的节点上。")]),s._v(" "),t("p",[s._v("Elastic-Job 中的定时调度都是由执行器自行触发，这种设计也被称为去中心化设计（调度和处理都是执行器单独完成）。")]),s._v(" "),t("div",{staticClass:"language-java extra-class"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Component")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@ElasticJobConf")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("name "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"dayJob"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" cron "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0/10 * * * * ?"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" shardingTotalCount "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        shardingItemParameters "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0=AAAA,1=BBBB"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" description "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"简单任务"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" failover "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("TestJob")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("implements")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("SimpleJob")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Override")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("execute")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ShardingContext")]),s._v(" shardingContext"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        log"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("info")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"TestJob任务名：【{}】, 片数：【{}】, param=【{}】"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" shardingContext"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getJobName")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" shardingContext"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getShardingTotalCount")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n                shardingContext"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("getShardingParameter")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n")])])]),t("p",[t("strong",[s._v("相关地址：")])]),s._v(" "),t("ul",[t("li",[s._v("Github 地址：https://github.com/apache/shardingsphere-elasticjob。")]),s._v(" "),t("li",[s._v("官方网站：https://shardingsphere.apache.org/elasticjob/index_zh.html 。")])]),s._v(" "),t("p",[t("strong",[s._v("优缺点总结：")])]),s._v(" "),t("ul",[t("li",[s._v("优点 ：可以与 "),t("code",[s._v("Spring")]),s._v(" 集成、支持分布式、支持集群、性能不错")]),s._v(" "),t("li",[s._v("缺点 ：依赖了额外的中间件比如 Zookeeper（复杂度增加，可靠性降低、维护成本变高）")])]),s._v(" "),t("h2",{attrs:{id:"xxl-job"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#xxl-job"}},[s._v("#")]),s._v(" XXL-JOB")]),s._v(" "),t("p",[t("code",[s._v("XXL-JOB")]),s._v(" 于 2015 年开源，是一款优秀的轻量级分布式任务调度框架，支持任务可视化管理、弹性扩容缩容、任务失败重试和告警、任务分片等功能，")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://notes-img2022.oss-cn-shenzhen.aliyuncs.com/img/20210608080550433.png",alt:"img"}})]),s._v(" "),t("p",[s._v("根据 "),t("code",[s._v("XXL-JOB")]),s._v(" 官网介绍，其解决了很多 "),t("code",[s._v("Quartz")]),s._v(" 的不足。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://notes-img2022.oss-cn-shenzhen.aliyuncs.com/img/20210607202503193.png",alt:"img"}})]),s._v(" "),t("p",[t("code",[s._v("XXL-JOB")]),s._v(" 的架构设计如下图所示：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://notes-img2022.oss-cn-shenzhen.aliyuncs.com/img/up-b8ecc6acf651f112c4dfae98243d72adea3.png",alt:"img"}})]),s._v(" "),t("p",[s._v("从上图可以看出，"),t("code",[s._v("XXL-JOB")]),s._v(" 由 "),t("strong",[s._v("调度中心")]),s._v(" 和 "),t("strong",[s._v("执行器")]),s._v(" 两大部分组成。调度中心主要负责任务管理、执行器管理以及日志管理。执行器主要是接收调度信号并处理。另外，调度中心进行任务调度时，是通过自研 RPC 来实现的。")]),s._v(" "),t("p",[s._v("不同于 "),t("code",[s._v("Elastic-Job")]),s._v(" 的去中心化设计， "),t("code",[s._v("XXL-JOB")]),s._v(" 的这种设计也被称为中心化设计（调度中心调度多个执行器执行任务）。")]),s._v(" "),t("p",[s._v("和 "),t("code",[s._v("Quzrtz")]),s._v(" 类似 "),t("code",[s._v("XXL-JOB")]),s._v(" 也是基于数据库锁调度任务，存在性能瓶颈。不过，一般在任务量不是特别大的情况下，没有什么影响的，可以满足绝大部分公司的要求。")]),s._v(" "),t("p",[s._v("不要被 "),t("code",[s._v("XXL-JOB")]),s._v(" 的架构图给吓着了，实际上，我们要用 "),t("code",[s._v("XXL-JOB")]),s._v(" 的话，只需要重写 "),t("code",[s._v("IJobHandler")]),s._v(" 自定义任务执行逻辑就可以了，非常易用！")]),s._v(" "),t("div",{staticClass:"language-java extra-class"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@JobHandler")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("value"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"myApiJobHandler"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Component")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("MyApiJobHandler")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("extends")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("IJobHandler")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Override")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ReturnT")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("execute")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" param"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throws")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Exception")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//......")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ReturnT")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("SUCCESS")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n")])])]),t("p",[s._v("还可以直接基于注解定义任务。")]),s._v(" "),t("div",{staticClass:"language-java extra-class"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@XxlJob")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"myAnnotationJobHandler"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ReturnT")]),t("span",{pre:!0,attrs:{class:"token generics"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("myAnnotationJobHandler")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" param"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throws")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Exception")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//......")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ReturnT")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("SUCCESS")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n")])])]),t("p",[t("strong",[s._v("相关地址：")])]),s._v(" "),t("ul",[t("li",[s._v("Github 地址：https://github.com/xuxueli/xxl-job/。")]),s._v(" "),t("li",[s._v("官方介绍：https://www.xuxueli.com/xxl-job/ 。")])]),s._v(" "),t("p",[t("strong",[s._v("优缺点总结：")])]),s._v(" "),t("ul",[t("li",[s._v("优点：开箱即用（学习成本比较低）、与 Spring 集成、支持分布式、支持集群、内置了 UI 管理控制台。")]),s._v(" "),t("li",[s._v("缺点：不支持动态添加任务（如果一定想要动态创建任务也是支持的，参见："),t("a",{attrs:{href:"https://github.com/xuxueli/xxl-job/issues/277",target:"_blank",rel:"noopener noreferrer"}},[s._v("xxl-job issue277"),t("OutboundLink")],1)])]),s._v(" "),t("h2",{attrs:{id:"powerjob"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#powerjob"}},[s._v("#")]),s._v(" PowerJob")]),s._v(" "),t("p",[s._v("非常值得关注的一个分布式任务调度框架，分布式任务调度领域的新星。目前，已经有很多公司接入比如 OPPO、京东、中通、思科。")]),s._v(" "),t("p",[s._v("这个框架的诞生也挺有意思的，PowerJob 的作者当时在阿里巴巴实习过，阿里巴巴那会使用的是内部自研的 SchedulerX（阿里云付费产品）。实习期满之后，PowerJob 的作者离开了阿里巴巴。想着说自研一个 SchedulerX，防止哪天 SchedulerX 满足不了需求，于是 PowerJob 就诞生了。")]),s._v(" "),t("p",[s._v("更多关于 PowerJob 的故事，小伙伴们可以去看看 PowerJob 作者的视频 "),t("a",{attrs:{href:"https://www.bilibili.com/video/BV1SK411A7F3/",target:"_blank",rel:"noopener noreferrer"}},[s._v("《我和我的任务调度中间件》"),t("OutboundLink")],1)]),s._v(" "),t("h1",{attrs:{id:"reference"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#reference"}},[s._v("#")]),s._v(" reference")]),s._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"https://javaguide.cn/system-design/%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Java定时任务大揭秘 | JavaGuide"),t("OutboundLink")],1)])])])}),[],!1,null,null,null);t.default=e.exports}}]);