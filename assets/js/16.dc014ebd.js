(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{346:function(t,s,e){"use strict";e.r(s);var a=e(7),_=Object(a.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"性能分析工具"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#性能分析工具"}},[t._v("#")]),t._v(" 性能分析工具")]),t._v(" "),s("h2",{attrs:{id:"查看系统性能参数"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#查看系统性能参数"}},[t._v("#")]),t._v(" 查看系统性能参数")]),t._v(" "),s("p",[t._v("在MySQL中，可以使用 "),s("code",[t._v("SHOW STATUS")]),t._v(" 语句查询一些MySQL数据库服务器的"),s("strong",[t._v("性能参数")]),t._v("、"),s("strong",[t._v("执行频率")]),t._v("。")]),t._v(" "),s("p",[t._v("语法如下：")]),t._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SHOW")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("GLOBAL")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SESSION")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("STATUS")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("LIKE")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'参数'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("常用的性能参数如下：")]),t._v(" "),s("ul",[s("li",[t._v("Connections：连接MySQL服务器的次数。")]),t._v(" "),s("li",[t._v("Uptime：MySQL服务器的上线时间。")]),t._v(" "),s("li",[t._v("Slow_queries：慢查询的次数。")]),t._v(" "),s("li",[t._v("Innodb_rows_read：Select查询返回的行数")]),t._v(" "),s("li",[t._v("Innodb_rows_inserted：执行INSERT操作插入的行数")]),t._v(" "),s("li",[t._v("Innodb_rows_updated：执行UPDATE操作更新的行数")]),t._v(" "),s("li",[t._v("Innodb_rows_deleted：执行DELETE操作删除的行数")]),t._v(" "),s("li",[t._v("Com_select：查询操作的次数。")]),t._v(" "),s("li",[t._v("Com_insert：插入操作的次数。对于批量插入的 INSERT 操作，只累加一次。")]),t._v(" "),s("li",[t._v("Com_update：更新操作的次数。")]),t._v(" "),s("li",[t._v("Com_delete：删除操作的次数。")])]),t._v(" "),s("h2",{attrs:{id:"统计sql的查询成本"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#统计sql的查询成本"}},[t._v("#")]),t._v(" 统计SQL的查询成本")]),t._v(" "),s("p",[t._v("执行一个查询SQL后，使用以下语句查看查询优化器的成本，Value列的值就是需要检索"),s("strong",[t._v("数据页的数量")]),t._v("。")]),t._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SHOW")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("STATUS")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("LIKE")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'last_query_cost'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("当有多个查询SQL可选时，可用来比较开销。")]),t._v(" "),s("h2",{attrs:{id:"慢查询日志"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#慢查询日志"}},[t._v("#")]),t._v(" 慢查询日志")]),t._v(" "),s("h3",{attrs:{id:"开启慢查询日志"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#开启慢查询日志"}},[t._v("#")]),t._v(" 开启慢查询日志")]),t._v(" "),s("ol",[s("li",[s("strong",[t._v("开启slow_query_log")])])]),t._v(" "),s("p",[t._v("使用"),s("code",[t._v("set global slow_query_log='ON';")]),t._v("开启慢查询日志。")]),t._v(" "),s("p",[t._v("然后查看慢查询日志是否开启以及慢查询日志文件的位置")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://notes-img2022.oss-cn-shenzhen.aliyuncs.com/img/image-20230208153230695.png",alt:"image-20230208153230695"}})]),t._v(" "),s("ol",{attrs:{start:"2"}},[s("li",[s("strong",[t._v("修改long_query_time阈值")])])]),t._v(" "),s("p",[t._v("long_query_time默认值为10s。")]),t._v(" "),s("p",[t._v("修改long_query_time的值为1s")]),t._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#session和global都得设置")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("set")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("global")]),t._v(" long_query_time "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("set")]),t._v(" long_query_time"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("h3",{attrs:{id:"查看慢查询数目"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#查看慢查询数目"}},[t._v("#")]),t._v(" 查看慢查询数目")]),t._v(" "),s("p",[t._v("查询当前系统中有多少条慢查询记录")]),t._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SHOW")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("GLOBAL")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("STATUS")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("LIKE")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'%Slow_queries%'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("h3",{attrs:{id:"慢查询日志分析工具-mysqldumpslow"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#慢查询日志分析工具-mysqldumpslow"}},[t._v("#")]),t._v(" 慢查询日志分析工具——mysqldumpslow")]),t._v(" "),s("p",[t._v("mysqldumpslow 命令的具体参数如下：")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("-a: 不将数字抽象成N，字符串抽象成S")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("-s: 是表示按照何种方式排序：")])]),t._v(" "),s("ul",[s("li",[s("p",[t._v("c: 访问次数")])]),t._v(" "),s("li",[s("p",[t._v("l: 锁定时间")])]),t._v(" "),s("li",[s("p",[t._v("r: 返回记录")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("t: 查询时间")])])]),t._v(" "),s("li",[s("p",[t._v("al:平均锁定时间")])]),t._v(" "),s("li",[s("p",[t._v("ar:平均返回记录数")])]),t._v(" "),s("li",[s("p",[t._v("at:平均查询时间 （默认方式）")])]),t._v(" "),s("li",[s("p",[t._v("ac:平均查询次数")])])])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("-t: 即为返回前面多少条的数据；")])])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("-g: 后边搭配一个正则匹配模式，大小写不敏感的；")])])])]),t._v(" "),s("p",[t._v("常用：")]),t._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#得到返回记录集最多的10个SQL")]),t._v("\nmysqldumpslow "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("s r "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("t "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("var"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("lib"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("mysql"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("atguigu"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("slow"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("log "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" more\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#得到访问次数最多的10个SQL")]),t._v("\nmysqldumpslow "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("s c "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("t "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("var"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("lib"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("mysql"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("atguigu"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("slow"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("log "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" more\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#得到按照时间排序的前10条里面含有左连接的查询语句")]),t._v("\nmysqldumpslow "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("s t "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("t "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("g "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"left join"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("var"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("lib"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("mysql"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("atguigu"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("slow"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("log "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" more\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#另外建议在使用这些命令时结合 | 和more 使用 ，否则有可能出现爆屏情况")]),t._v("\nmysqldumpslow "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("s r "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("t "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("var"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("lib"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("mysql"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("atguigu"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("slow"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("log "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" more\n")])])]),s("h3",{attrs:{id:"关闭慢查询日志"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#关闭慢查询日志"}},[t._v("#")]),t._v(" 关闭慢查询日志")]),t._v(" "),s("p",[s("strong",[t._v("方式1：永久性方式")])]),t._v(" "),s("p",[t._v("修改mysql配置文件"),s("code",[t._v("slow_query_log=OFF")]),t._v("或者将"),s("code",[t._v("slow_query_log")]),t._v("注释或删除掉，然后重启MySQL服务。")]),t._v(" "),s("p",[s("strong",[t._v("方式2：临时性方式")])]),t._v(" "),s("p",[t._v("使用")]),t._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SET")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("GLOBAL")]),t._v(" slow_query_log"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("off")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("p",[t._v("关闭慢查询日志，然后重启MySQL服务。")]),t._v(" "),s("h2",{attrs:{id:"查看sql执行成本"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#查看sql执行成本"}},[t._v("#")]),t._v(" 查看SQL执行成本")]),t._v(" "),s("p",[t._v("通过 "),s("code",[t._v("set profiling = 'ON'")]),t._v("来开启show profile。")]),t._v(" "),s("p",[t._v("使用show profiles会列出当前会话都有哪些查询和对应开销。")]),t._v(" "),s("h2",{attrs:{id:"explain-查看执行计划"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#explain-查看执行计划"}},[t._v("#")]),t._v(" EXPLAIN 查看执行计划")]),t._v(" "),s("p",[t._v("官网介绍：")]),t._v(" "),s("ul",[s("li",[t._v("MySQL 5.7 ：https://dev.mysql.com/doc/refman/5.7/en/explain-output.html")]),t._v(" "),s("li",[t._v("MySQL 8.0：https://dev.mysql.com/doc/refman/8.0/en/explain-output.html")])]),t._v(" "),s("p",[s("strong",[t._v("版本变化")]),t._v("：")]),t._v(" "),s("ul",[s("li",[t._v("MySQL 5.6.3以前只能 EXPLAIN SELECT ；MYSQL 5.6.3以后就可以 EXPLAIN SELECT，UPDATE，DELETE。")]),t._v(" "),s("li",[t._v("在5.7以前的版本中，想要显示 partitions 需要使用 explain partitions 命令；想要显示filtered 需要使用 explain extended 命令。在5.7版本后，默认explain直接显示partitions和filtered中的信息。")])]),t._v(" "),s("p",[t._v("注意：")]),t._v(" "),s("ul",[s("li",[t._v("EXPLAIN不考虑各种Cache")]),t._v(" "),s("li",[t._v("EXPLAIN不能显示MySQL在执行查询时所作的优化工作")]),t._v(" "),s("li",[t._v("EXPLAIN不会告诉你关于触发器、存储过程的信息或用户自定义函数对查询的影响情况")])]),t._v(" "),s("h3",{attrs:{id:"基本语法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#基本语法"}},[t._v("#")]),t._v(" 基本语法")]),t._v(" "),s("p",[t._v("可以使用EXPLAIN或DESCRIBE语法查看执行计划")]),t._v(" "),s("div",{staticClass:"language-sql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("EXPLAIN")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" select_options\n或者\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DESCRIBE")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" select_options\n")])])]),s("p",[t._v("如果想查看某个查询SQL的执行计划，在具体的查询SQL前边加上EXPLAIN就可以，比如"),s("code",[t._v("EXPLAIN SELECT 1")]),t._v("。输出各个列的作用如下：")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("列名")]),t._v(" "),s("th",[t._v("描述")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[s("code",[t._v("id")])]),t._v(" "),s("td",[t._v("在一个大的查询语句中个SELECT关键字都对应一个"),s("code",[t._v("唯一的id")])])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("select_type")])]),t._v(" "),s("td",[t._v("SELECT关键字对应的那个查询的类型")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("table")])]),t._v(" "),s("td",[t._v("表名")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("partitions")])]),t._v(" "),s("td",[t._v("匹配的分区信息")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("type")])]),t._v(" "),s("td",[t._v("针对单表的访问方法")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("possible_keys")])]),t._v(" "),s("td",[t._v("可能用到的索引")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("key")])]),t._v(" "),s("td",[t._v("实际上使用的索引")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("key_len")])]),t._v(" "),s("td",[t._v("实际使用到的索引长度（联合索引时可以看用了几个索引列）")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("ref")])]),t._v(" "),s("td",[t._v("当使用索引列等值查询时，与索引列进行等值匹配的对象信息")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("rows")])]),t._v(" "),s("td",[t._v("预估的需要读取的记录条数")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("filtered")])]),t._v(" "),s("td",[t._v("某个表经过搜索条件过滤后剩余记录条数的百分比")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("Extra")])]),t._v(" "),s("td",[t._v("一些额外的信息")])])])]),t._v(" "),s("h3",{attrs:{id:"explain各个列的作用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#explain各个列的作用"}},[t._v("#")]),t._v(" EXPLAIN各个列的作用")]),t._v(" "),s("h4",{attrs:{id:"id"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#id"}},[t._v("#")]),t._v(" id")]),t._v(" "),s("p",[t._v("SQL执行的顺序标识，每个select关键字对应一个id。")]),t._v(" "),s("ul",[s("li",[t._v("id如果相同，可以认为是一组，从上往下顺序执行")]),t._v(" "),s("li",[t._v("在所有组中，id值越大，优先级越高，越先执行")]),t._v(" "),s("li",[t._v("关注点：id号每个号码，表示一趟独立的查询, 一个sql的查询趟数越少越好")])]),t._v(" "),s("h4",{attrs:{id:"select-type"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#select-type"}},[t._v("#")]),t._v(" select_type")]),t._v(" "),s("p",[t._v("每个select查询的类型")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("名称")]),t._v(" "),s("th",[t._v("描述")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[s("code",[t._v("SIMPLE")])]),t._v(" "),s("td",[t._v("简单查询（不使用 UNION 或子查询）")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("PRIMARY")])]),t._v(" "),s("td",[t._v("查询中若包含任何复杂的子部分,最外层的select被标记为PRIMARY")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("UNION")])]),t._v(" "),s("td",[t._v("UNION中的第二个或后面的SELECT语句")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("UNION RESULT")])]),t._v(" "),s("td",[t._v("UNION的结果")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("SUBQUERY")])]),t._v(" "),s("td",[t._v("子查询中的第一个SELECT")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("DEPENDENT SUBQUERY")])]),t._v(" "),s("td",[t._v("子查询中的第一个SELECT，取决于外面的查询")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("DEPENDENT UNION")])]),t._v(" "),s("td",[t._v("UNION中的第二个或后面的SELECT语句，取决于外面的查询")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("DERIVED")])]),t._v(" "),s("td",[t._v("派生表的SELECT, FROM子句的子查询")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("MATERIALIZED")])]),t._v(" "),s("td",[t._v("Materialized subquery")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("UNCACHEABLE SUBQUERY")])]),t._v(" "),s("td",[t._v("A subquery for which the result cannot be cached and must be re-evaluated for"),s("br"),t._v("each row of the outer query")])]),t._v(" "),s("tr",[s("td",[s("code",[t._v("UNCACHEABLE UNION")])]),t._v(" "),s("td",[t._v("The second or later select in a UNION that belongs to an uncacheable subquery"),s("br"),t._v("(see UNCACHEABLE SUBQUERY)")])])])]),t._v(" "),s("h4",{attrs:{id:"table"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#table"}},[t._v("#")]),t._v(" table")]),t._v(" "),s("p",[t._v("查询语句无论多复杂，最终还是对每个表进行"),s("strong",[t._v("单表访问")]),t._v("。所\n以MySQL规定"),s("strong",[t._v("EXPLAIN语句输出的每条记录都对应着某个单表的访问方法")]),t._v("，该条记录的table列代表着该表的表名（有时不是真实的表名字，可能是简称）")]),t._v(" "),s("h4",{attrs:{id:"partitions"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#partitions"}},[t._v("#")]),t._v(" partitions")]),t._v(" "),s("p",[t._v("匹配的分区信息")]),t._v(" "),s("h4",{attrs:{id:"type"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#type"}},[t._v("#")]),t._v(" type")]),t._v(" "),s("p",[t._v("针对单表的访问方法，即MySQL决定如何查找表中的行。")]),t._v(" "),s("p",[t._v("完整的访问方法如下：system、const、eq_ref、ref、fulltext、ref_or_null、index_merge、unique_subquery、index_subquery、range、index、ALL。")]),t._v(" "),s("p",[t._v("结果值从最好到最坏依次是： "),s("strong",[t._v("system > const > eq_ref > ref")]),t._v(" > fulltext > ref_or_null > index_merge > unique_subquery > index_subquery > "),s("strong",[t._v("range > index > ALL")])]),t._v(" "),s("blockquote",[s("p",[t._v("SQL性能优化的目标：至少要达到 range 级别，要求是 ref 级别，最好是consts级别。（阿里巴巴开发手册要求）")])]),t._v(" "),s("h4",{attrs:{id:"possible-keys和key"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#possible-keys和key"}},[t._v("#")]),t._v(" possible_keys和key")]),t._v(" "),s("p",[t._v("possible_keys：可能使用哪些索引来查找")]),t._v(" "),s("p",[t._v("key：实际使用哪些索引查找")]),t._v(" "),s("h4",{attrs:{id:"key-len"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#key-len"}},[t._v("#")]),t._v(" key_len")]),t._v(" "),s("p",[t._v("这一列显示了mysql在索引里使用的字节数，通过这个值可以算出具体使用了索引中的哪些列（"),s("strong",[t._v("主要用于联合索引")]),t._v("）。")]),t._v(" "),s("p",[t._v("举例来说，film_actor的联合索引 idx_film_actor_id 由 film_id 和 actor_id 两个int列组成，并且每个int是4字节。通过结果中的key_len=4可推断出查询使用了第一个列：film_id列来执行索引查找。")]),t._v(" "),s("div",{staticClass:"language-mysql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("mysql> explain select * from film_actor where film_id = 2;\n+----+-------------+------------+------+-------------------+-------------------+---------+-------+------+-------------+\n| id | select_type | table      | type | possible_keys     | key               | key_len | ref   | rows | Extra       |\n+----+-------------+------------+------+-------------------+-------------------+---------+-------+------+-------------+\n|  1 | SIMPLE      | film_actor | ref  | idx_film_actor_id | idx_film_actor_id | 4       | const |    1 | Using index |\n+----+-------------+------------+------+-------------------+-------------------+---------+-------+------+-------------+\n")])])]),s("p",[t._v("key_len计算规则如下：")]),t._v(" "),s("ul",[s("li",[t._v("字符串\n"),s("ul",[s("li",[t._v("char(n)：n字节长度")]),t._v(" "),s("li",[t._v("varchar(n)：2字节存储字符串长度，如果是utf-8，则长度 3n + 2")])])]),t._v(" "),s("li",[t._v("数值类型\n"),s("ul",[s("li",[t._v("tinyint：1字节")]),t._v(" "),s("li",[t._v("smallint：2字节")]),t._v(" "),s("li",[t._v("int：4字节")]),t._v(" "),s("li",[t._v("bigint：8字节")])])]),t._v(" "),s("li",[t._v("时间类型\n"),s("ul",[s("li",[t._v("date：3字节")]),t._v(" "),s("li",[t._v("timestamp：4字节")]),t._v(" "),s("li",[t._v("datetime：8字节")])])]),t._v(" "),s("li",[t._v("如果字段允许为 NULL，需要1字节记录是否为 NULL")])]),t._v(" "),s("h4",{attrs:{id:"ref"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ref"}},[t._v("#")]),t._v(" ref")]),t._v(" "),s("p",[t._v("这一列显示了在key列记录的索引中，表查找值所用到的列或常量，常见的有：const（常量），func，NULL，字段名（例：film.id）")]),t._v(" "),s("h4",{attrs:{id:"rows"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#rows"}},[t._v("#")]),t._v(" rows")]),t._v(" "),s("p",[t._v("这一列是mysql估计要读取并检测的行数，注意这个不是结果集里的行数。")]),t._v(" "),s("h4",{attrs:{id:"filtered"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#filtered"}},[t._v("#")]),t._v(" filtered")]),t._v(" "),s("p",[t._v("某个表经过搜索条件过滤后剩余记录条数的百分比。这个值越大越好。")]),t._v(" "),s("h4",{attrs:{id:"extra"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#extra"}},[t._v("#")]),t._v(" Extra")]),t._v(" "),s("p",[t._v("这一列展示的是额外信息。常见的重要值如下：")]),t._v(" "),s("ul",[s("li",[s("strong",[s("code",[t._v("distinct")])]),t._v("： 一旦mysql找到了与行相联合匹配的行，就不再搜索了")]),t._v(" "),s("li",[s("strong",[s("code",[t._v("Using index")])]),t._v("：这发生在对表的请求列都是同一索引的部分的时候，返回的列数据只使用了索引中的信息，而没有再去访问表中的行记录。是性能高的表现。")]),t._v(" "),s("li",[s("strong",[s("code",[t._v("Using where")])]),t._v("：mysql服务器将在存储引擎检索行后再进行过滤。就是先读取整行数据，再按 where 条件进行检查，符合就留下，不符合就丢弃。")]),t._v(" "),s("li",[s("strong",[s("code",[t._v("Using temporary")])]),t._v("：mysql需要创建一张临时表来处理查询。出现这种情况一般是要进行优化的，首先是想到用索引来优化。")]),t._v(" "),s("li",[s("strong",[s("code",[t._v("Using filesort")])]),t._v("：mysql 会对结果使用一个外部索引排序，而不是按索引次序从表里读取行。此时mysql会根据联接类型浏览所有符合条件的记录，并保存排序关键字和行指针，然后排序关键字并按顺序检索行信息。这种情况下一般也是要考虑使用索引来优化的。")])]),t._v(" "),s("h2",{attrs:{id:"mysql监控分析视图-sys-schemea"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mysql监控分析视图-sys-schemea"}},[t._v("#")]),t._v(" MySQL监控分析视图-sys schemea")]),t._v(" "),s("h3",{attrs:{id:"sys-schemea视图摘要"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#sys-schemea视图摘要"}},[t._v("#")]),t._v(" Sys schemea视图摘要")]),t._v(" "),s("ol",[s("li",[t._v("主机相关：以host_summary开头，主要汇总了IO延迟的信息。")]),t._v(" "),s("li",[t._v("Innodb相关：以innodb开头，汇总了innodb buffer信息和事务等待innodb锁的信息。")]),t._v(" "),s("li",[t._v("I/o相关：以io开头，汇总了等待I/O、I/O使用量情况。")]),t._v(" "),s("li",[t._v("内存使用情况：以memory开头，从主机、线程、事件等角度展示内存的使用情况")]),t._v(" "),s("li",[t._v("连接与会话信息：processlist和session相关视图，总结了会话相关信息。")]),t._v(" "),s("li",[t._v("表相关：以schema_table开头的视图，展示了表的统计信息。")]),t._v(" "),s("li",[t._v("索引信息：统计了索引的使用情况，包含冗余索引和未使用的索引情况。")]),t._v(" "),s("li",[t._v("语句相关：以statement开头，包含执行全表扫描、使用临时表、排序等的语句信息。")]),t._v(" "),s("li",[t._v("用户相关：以user开头的视图，统计了用户使用的文件I/O、执行语句统计信息。")]),t._v(" "),s("li",[t._v("等待事件相关信息：以wait开头，展示等待事件的延迟情况。")])]),t._v(" "),s("h3",{attrs:{id:"sys-schemea视图使用场景"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#sys-schemea视图使用场景"}},[t._v("#")]),t._v(" Sys schemea视图使用场景")]),t._v(" "),s("p",[s("strong",[t._v("索引情况")]),t._v("：")]),t._v(" "),s("div",{staticClass:"language-mysql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("#1. 查询冗余索引\nselect * from sys.schema_redundant_indexes;\n#2. 查询未使用过的索引\nselect * from sys.schema_unused_indexes;\n#3. 查询索引的使用情况\nselect index_name,rows_selected,rows_inserted,rows_updated,rows_deleted\nfrom sys.schema_index_statistics where table_schema='dbname' ;\n")])])]),s("p",[s("strong",[t._v("表相关")]),t._v("：")]),t._v(" "),s("div",{staticClass:"language-mysql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("# 1. 查询表的访问量\nselect table_schema,table_name,sum(io_read_requests+io_write_requests) as io from\nsys.schema_table_statistics group by table_schema,table_name order by io desc;\n# 2. 查询占用bufferpool较多的表\nselect object_schema,object_name,allocated,data\nfrom sys.innodb_buffer_stats_by_table order by allocated limit 10;\n# 3. 查看表的全表扫描情况\nselect * from sys.statements_with_full_table_scans where db='dbname';\n")])])]),s("p",[s("strong",[t._v("语句相关")]),t._v("：")]),t._v(" "),s("div",{staticClass:"language-mysql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("#1. 监控SQL执行的频率\nselect db,exec_count,query from sys.statement_analysis\norder by exec_count desc;\n#2. 监控使用了排序的SQL\nselect db,exec_count,first_seen,last_seen,query\nfrom sys.statements_with_sorting limit 1;\n#3. 监控使用了临时表或者磁盘临时表的SQL\nselect db,exec_count,tmp_tables,tmp_disk_tables,query\nfrom sys.statement_analysis where tmp_tables>0 or tmp_disk_tables >0\norder by (tmp_tables+tmp_disk_tables) desc;\n")])])]),s("p",[s("strong",[t._v("IO相关")]),t._v("：")]),t._v(" "),s("div",{staticClass:"language-mysql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("#1. 查看消耗磁盘IO的文件\nselect file,avg_read,avg_write,avg_read+avg_write as avg_io\nfrom sys.io_global_by_file_by_bytes order by avg_read limit 10;\n")])])]),s("p",[s("strong",[t._v("InnoDB相关")]),t._v("：")]),t._v(" "),s("div",{staticClass:"language-mysql extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("#1. 行锁阻塞情况\nselect * from sys.innodb_lock_waits;\n")])])]),s("h1",{attrs:{id:"sql-优化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#sql-优化"}},[t._v("#")]),t._v(" SQL 优化")]),t._v(" "),s("p",[t._v("SQL查询优化可以分成"),s("strong",[t._v("物理查询优化")]),t._v("和"),s("strong",[t._v("逻辑查询优化")]),t._v("。")]),t._v(" "),s("ul",[s("li",[t._v("物理查询优化：索引、表连接")]),t._v(" "),s("li",[t._v("逻辑查询优化：SQL等价变换")])]),t._v(" "),s("h2",{attrs:{id:"索引优化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#索引优化"}},[t._v("#")]),t._v(" 索引优化")]),t._v(" "),s("h3",{attrs:{id:"索引失效的情况"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#索引失效的情况"}},[t._v("#")]),t._v(" 索引失效的情况")]),t._v(" "),s("ol",[s("li",[s("p",[s("strong",[t._v("优化全值匹配")]),t._v("：优先使用联合索引而不是单列索引。")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("最佳左前缀法则")]),t._v("：对于多列索引，过滤条件要使用索引必须按照索引建立的顺序，依次满足，一旦跳过某个字段，索引后面的字段都无法被使用。如果查询条件没有使用第一个字段，联合索引不会被使用。")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("主键插入顺序")]),t._v("：最好让主键依次递增，避免页分裂和记录移位造成的性能损耗。")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("计算、函数导致索引失效")])])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("类型转换（自动或手动）导致索引失效")])])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("范围条件右边的列索引失效")])])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("不等于（!=或者<>）索引失效")])])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("is null可以使用索引,is not null无法使用索引")])])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("like以通配符%开头索引失效")])])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("OR前后存在非索引的列，索引失效")])])]),t._v(" "),s("li",[s("p",[t._v("数据库和表的字符集统一使用utf8mb4："),s("strong",[t._v("不同字符集进行比较前需要进行转换造成索引失效。")])])])]),t._v(" "),s("h2",{attrs:{id:"关联查询优化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#关联查询优化"}},[t._v("#")]),t._v(" 关联查询优化")]),t._v(" "),s("p",[t._v("内连接时，查询优化器可以决定哪张表为驱动表，如果表的连接条件中只能有一个字段有索引，则有索引的字段所在的表会被作为被驱动表。")]),t._v(" "),s("p",[t._v("对于内连接来说，在两个表的连接条件都存在索引的情况下，小表驱动大表（小的结果集驱动大的结果集）。")]),t._v(" "),s("h3",{attrs:{id:"join底层原理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#join底层原理"}},[t._v("#")]),t._v(" JOIN底层原理")]),t._v(" "),s("h4",{attrs:{id:"简单嵌套循环连接"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#简单嵌套循环连接"}},[t._v("#")]),t._v(" 简单嵌套循环连接")]),t._v(" "),s("p",[t._v("都无索引。性能主要受被驱动表的全表扫描次数，也就是驱动表匹配数据。")]),t._v(" "),s("h4",{attrs:{id:"索引嵌套循环连接"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#索引嵌套循环连接"}},[t._v("#")]),t._v(" 索引嵌套循环连接")]),t._v(" "),s("p",[t._v("表中添加索引，被驱动表为加了索引的表，无须全表扫描。")]),t._v(" "),s("h4",{attrs:{id:"块嵌套循环连接"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#块嵌套循环连接"}},[t._v("#")]),t._v(" 块嵌套循环连接")]),t._v(" "),s("p",[t._v("驱动表一块一块获取多条数据，减少非驱动表的全表扫描。")]),t._v(" "),s("h2",{attrs:{id:"子查询优化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#子查询优化"}},[t._v("#")]),t._v(" 子查询优化")]),t._v(" "),s("p",[t._v("子查询会建立临时表，影响查询性能。在MySQL中可以使用JOIN查询来替代子查询。")]),t._v(" "),s("h2",{attrs:{id:"排序优化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#排序优化"}},[t._v("#")]),t._v(" 排序优化")]),t._v(" "),s("p",[t._v("MySQL支持两种排序方式，分别"),s("code",[t._v("FileSort")]),t._v("和"),s("code",[t._v("Index")]),t._v("排序")]),t._v(" "),s("ul",[s("li",[t._v("Index排序中，索引可以保证数据的有序性，不需要再进行排序，效率更高")]),t._v(" "),s("li",[t._v("FileSort排序一般在内存中进行排序，效率较低。")])]),t._v(" "),s("p",[t._v("在Order by 子句中使用索引，避免使用FileSort排序。")]),t._v(" "),s("h2",{attrs:{id:"group-by优化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#group-by优化"}},[t._v("#")]),t._v(" GROUP BY优化")]),t._v(" "),s("p",[t._v("group by 先排序再分组，遵照索引建的最佳左前缀法则")]),t._v(" "),s("h2",{attrs:{id:"函数优化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#函数优化"}},[t._v("#")]),t._v(" 函数优化")]),t._v(" "),s("p",[t._v("max/min函数：使用"),s("code",[t._v("order by 列名 limit 1")]),t._v("进行优化")])])}),[],!1,null,null,null);s.default=_.exports}}]);